<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <title>IPä¿¡æ¯æŸ¥è¯¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" crossorigin/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js" crossorigin></script>
</head>

<body>
<button id="theme-toggle" title="åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼" aria-label="Toggle Dark Mode">ğŸŒ</button>

<main>
    <h1>IPä¿¡æ¯æŸ¥è¯¢</h1>
    <div class="input-group">
        <input type="text" id="ipInput" placeholder="è¯·è¾“å…¥IPåœ°å€" onkeypress="handleKeyPress(event)">
        <button id="query-button" onclick="getIPInfo()">æŸ¥è¯¢</button>
    </div>
    <div id="result"></div>
    <div id="map" style="display: none;"></div>
</main>
<script>
    window.onload = () => {
        initTheme();
        getLocalIPInfo();
    };

    // åˆ‡æ¢ä¸»é¢˜
    const themeToggle = document.getElementById('theme-toggle');

    window.addEventListener('scroll', () => {
        if (window.scrollY === 0) {
            // æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶æ˜¾ç¤º
            themeToggle.style.opacity = '1';
            themeToggle.style.pointerEvents = 'auto';
        } else {
            // æ»šåŠ¨ç¦»å¼€é¡¶éƒ¨æ—¶éšè—
            themeToggle.style.opacity = '0';
            themeToggle.style.pointerEvents = 'none';
        }
    });

    function applyTheme(theme) {
        const isDark = theme === 'dark';
        document.body.classList.toggle('dark', isDark);
        themeToggle.textContent = isDark ? 'ğŸŒ™' : 'ğŸŒ';
        themeToggle.title = isDark ? 'åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼' : 'åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼';
        localStorage.setItem('theme', theme);
    }

    let currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(currentTheme);

    themeToggle.addEventListener('click', () => {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(currentTheme);
    });

    themeToggle.addEventListener('mouseenter', () => {
        themeToggle.textContent = currentTheme === 'dark' ? 'ğŸŒ' : 'ğŸŒ™';
    });
    themeToggle.addEventListener('mouseleave', () => {
        themeToggle.textContent = currentTheme === 'dark' ? 'ğŸŒ™' : 'ğŸŒ';
    });

    async function getLocalIPInfo() {
        const resultDiv = document.getElementById("result");
        const mapDiv = document.getElementById("map");
        resultDiv.innerHTML = '<div class="loader"></div>';
        mapDiv.style.display = "none";

        try {
            const data = await fetch("https://speed.cloudflare.com/meta").then(res => res.json());

            // å¡«å……ipInputæ¡†
            const ipInput = document.getElementById("ipInput");
            ipInput.value = data.clientIp || "";

            // ç”¨åŒä¸€ä¸ªæ˜¾ç¤ºå‡½æ•°
            displayLocalResult(data);
        } catch (err) {
            resultDiv.innerHTML = `<h3>è¯·æ±‚å¤±è´¥</h3><p><strong>é”™è¯¯:</strong> ${err.message}</p>`;
        }
    }

    async function getIPInfo() {
        const ip = document.getElementById("ipInput").value.trim();
        const resultDiv = document.getElementById("result");
        const mapDiv = document.getElementById("map");
        resultDiv.innerHTML = '<div class="loader"></div>';
        mapDiv.style.display = "none";

        if (!ip) return alert("è¯·è¾“å…¥IPåœ°å€");
        if (!isValidIPv4(ip) && !isValidIPv6(ip)) {
            alert("è¯·è¾“å…¥æœ‰æ•ˆIPåœ°å€");
            resultDiv.innerHTML = "";
            return;
        }

        try {
            // å¹¶å‘è¯·æ±‚ä¸¤ä¸ªæ¥å£
            let [data1, data2] = await Promise.all([
                fetch(`https://ipinfo.chigua.tk/${ip}`).then(res => res.json()),
                fetch(`https://ipapi.co/${ip}/json`).then(res => res.json()),
            ]);

            if (data1.error) {
                resultDiv.innerHTML = `<h3>æŸ¥è¯¢é”™è¯¯</h3><p><strong>é”™è¯¯:</strong> ${data1.error || "æ— æ•ˆIP"}</p>`;
                return;
            }
            if (data2.error) {
                // ç¬¬äºŒä¸ªæ¥å£é”™è¯¯ä¹Ÿä¸é˜»æ­¢æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ¥å£æ•°æ®ï¼Œä½†å¯ä»¥æç¤º
                data2 = {};
            }

            // å®šä¹‰éœ€è¦ä¿ç•™çš„å­—æ®µç™½åå•ï¼ˆç¤ºä¾‹å­—æ®µï¼Œè¯·æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ï¼‰
            const PRESERVE_FIELDS = ['postal'];

            // åˆå¹¶ä¸¤ä¸ªæ¥å£æ•°æ®ï¼Œç¬¬äºŒä¸ªæ¥å£å­—æ®µä¼˜å…ˆè¦†ç›–åŒåå­—æ®µ
            const mergedData = {
                ...data2, // ä¼˜å…ˆå±•å¼€ç¬¬äºŒä¸ªæ¥å£çš„æ•°æ®
                ...Object.fromEntries(
                    PRESERVE_FIELDS
                        .filter(key => key in data1)
                        .map(key => [key, data1[key]])
                )
            };

            displayQueryResult(mergedData);
        } catch (err) {
            resultDiv.innerHTML = `<h3>è¯·æ±‚å¤±è´¥</h3><p><strong>é”™è¯¯:</strong> ${err.message}</p>`;
        }
    }

    function displayLocalResult(data) {
        const div = document.getElementById("result");
        const ipInput = document.getElementById("ipInput");
        ipInput.value = data.clientIp;
        getIPInfo()
    }

    function displayQueryResult(data) {
        const div = document.getElementById("result");
        const ipInput = document.getElementById("ipInput");
        ipInput.value = data.ip || "";

        // ç»çº¬åº¦ç”¨ipinfoçš„locæˆ–è€…ipapiçš„latitude/longitude
        let lat = "", lng = "";
        if (data.latitude && data.longitude) {
            lat = data.latitude;
            lng = data.longitude;
        }

        if (lat === "" || lng === "") {
            if (data.loc) {
                [lat, lng] = data.loc.split(",");
            }
        }

        div.innerHTML = `
                <h3>IPæŸ¥è¯¢ç»“æœ</h3>
                <p><strong>IPåœ°å€:</strong> ${data.ip || "æœªçŸ¥"}</p>
                <p><strong>ç½‘æ®µ:</strong> ${data.network || "æœªçŸ¥"}</p>
                <p><strong>ä¸»æœºå:</strong> ${data.hostname || "æœªçŸ¥"}</p>
                <p><strong>å›½å®¶:</strong> ${data.country || data.country_name || "æœªçŸ¥"}</p>
                <p><strong>åœ°åŒº:</strong> ${data.region || "æœªçŸ¥"}</p>
                <p><strong>åŸå¸‚:</strong> ${data.city || "æœªçŸ¥"}</p>
                <p><strong>ç»„ç»‡:</strong> ${data.org || data.org || "æœªçŸ¥"}</p>
                <p><strong>ASN:</strong> ${data.asn || "æœªçŸ¥"}</p>
                <p><strong>æ•°æ®ä¸­å¿ƒ:</strong> ${data.country_code_iso3 || "æœªçŸ¥"}</p>
                <p><strong>ç”µè¯åŒºå·:</strong> ${data.country_calling_code || "æœªçŸ¥"}</p>
                <p><strong>è´§å¸:</strong> ${data.currency || "æœªçŸ¥"}</p>
                <p><strong>è¯­è¨€:</strong> ${data.languages || "æœªçŸ¥"}</p>
                <p><strong>é‚®ç¼–:</strong> ${data.postal || "æœªçŸ¥"}</p>
                <p><strong>æ—¶åŒº:</strong> ${data.timezone + " " + data.utc_offset || "æœªçŸ¥"}</p>
                <p><strong>çº¬åº¦:</strong> ${lat || "æœªçŸ¥"}</p>
                <p><strong>ç»åº¦:</strong> ${lng || "æœªçŸ¥"}</p>
                <p><strong>ä»»æ’­:</strong> ${data.anycast ? "æ˜¯" : "å¦"}</p>
            `;

        if (lat && lng) displayMap(parseFloat(lat), parseFloat(lng), data.city || "");
    }


    let map;

    function displayMap(lat, lng, name) {
        document.getElementById("map").style.display = "block";
        if (map) map.remove();
        map = L.map("map").setView([lat, lng], 10);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            // attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);
        L.marker([lat, lng]).addTo(map).bindPopup(`<b>${name}</b><br/>çº¬åº¦: ${lat}<br/>ç»åº¦: ${lng}`).openPopup();
    }

    function isValidIPv4(ip) {
        return /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
    }

    function isValidIPv6(ip) {
        return /:/.test(ip);
    }

    function handleKeyPress(e) {
        if (e.key === "Enter") getIPInfo();
    }

    function handleInvalidParameter(res) {
        document.getElementById("result").innerHTML = `<h3>æŸ¥è¯¢é”™è¯¯</h3><p><strong>é”™è¯¯:</strong> ${res.error || "æ— æ•ˆIP"}</p>`;
    }

    function handleRequestError(err) {
        document.getElementById("result").innerHTML = `<h3>è¯·æ±‚å¤±è´¥</h3><p><strong>é”™è¯¯:</strong> ${err.message}</p>`;
    }

    function toggleTheme() {
        document.body.classList.toggle("dark");
        localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    function initTheme() {
        const saved = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        if (saved === "dark" || (!saved && prefersDark)) document.body.classList.add("dark");
    }
</script>
</body>
<style>
    :root {
        --bg-color: #ffffff;
        --text-color: #1a1a1a;
        --card-bg: #f9fbfd;
        --button-bg: #007bff;
        --button-text: #ffffff;
        --input-bg: #fff;
        --border-color: #ccc;
    }

    body.dark {
        --bg-color: #121212;
        --text-color: #f0f0f0;
        --card-bg: #1e1e1e;
        --button-bg: #3399ff;
        --button-text: #ffffff;
        --input-bg: #1e1e1e;
        --border-color: #444;
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }

    main {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background-color: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s, color 0.3s;
    }

    h1 {
        text-align: center;
        font-size: 28px;
        margin-bottom: 20px;
    }

    .input-group {
        display: flex;
        margin: 0 auto 20px auto;
        box-shadow: 0 0 0 1px var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    #ipInput {
        flex: 1;
        padding: 12px 16px;
        font-size: 16px;
        border: none;
        outline: none;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    #query-button {
        padding: 0 20px;
        font-size: 16px;
        background-color: var(--button-bg);
        color: var(--button-text);
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    #query-button:hover {
        background-color: #005ec4;
    }

    #result {
        margin-top: 20px;
        padding: 20px 25px;
        background-color: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #result h3 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 20px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 8px;
    }

    #result p {
        margin: 10px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #eaeaea;
        font-size: 15px;
    }

    #result strong {
        display: inline-block;
        width: 90px;
    }

    #map {
        width: 100%;
        height: 400px;
        margin-top: 25px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.05);
    }

    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 0.8s linear infinite;
        margin: 20px auto;
    }

    body.dark {
        background-color: #1e1e1e;
        color: #f0f0f0;
        transition: background-color 0.3s, color 0.3s;
    }

    #theme-toggle {
        position: fixed;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        z-index: 9999;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #theme-toggle:hover {
        transform: scale(1.2);
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

</html>