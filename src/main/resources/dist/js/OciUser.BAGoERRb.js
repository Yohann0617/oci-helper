import{B,C as I,D as z,G as R,H as q,I as A,c as O,a as g,b as t,w as s,r,x as J,z as j,m as K,F as M,j as u,J as G,o as D,q as o,t as f}from"./chunk-vendors.CdTauPKY.js";import{c as H,a as Q}from"./common.CZhk_xKy.js";import{_ as W}from"./index.C40PP_gZ.js";const X={components:{ElTable:A,ElTableColumn:q,ElPagination:R,ElInput:z,ElButton:I,UploadFilled:B},data(){return{updateCfgParams:{cfgId:"",updateCfgName:""},updateCfgDialog:!1,updateCfgLoading:!1,checkLoading:!1,checkResult:"",users:[],pageParams:{keyword:"",currentPage:1,pageSize:10,isEnableCreate:null},total:2,selectedUsers:[],loading:!0,addLoading:!1,dialogVisible:!1,checkDialogVisible:!1,activeTab:"manual",fileList:[],singleFileList:[],addCfgFormData:{disabled:!1,username:"",ociCfgStr:"",file:null},formRules:{username:[{required:!0,message:"配置名称不能为空",trigger:"blur"},{min:1,message:"配置名称至少为 1 个字符",trigger:"blur"}],ociCfgStr:[{required:!0,message:"配置内容不能为空",trigger:"blur"},{min:10,message:"配置内容至少为 10 个字符",trigger:"blur"}],file:[{required:!0,message:"私钥文件不能为空",trigger:"change"}]},placeholderText:`user=ocid1.user.oc1..aaaaaaaaxxx
fingerprint=c6:1b:9f:cd:01:9d:7a:xxx
tenancy=ocid1.tenancy.oc1..aaaaaaaaxxx
region=sa-saopaulo-1
`}},watch:{addCfgFormData:{handler(){this.validateForm()},deep:!0}},methods:{copyToClipboard:H,async fetchUsers(){this.loading=!0,this.$axios.post("/oci/userPage",{...this.pageParams}).then(l=>{this.users=l.data.data.records,this.total=l.data.data.total}).catch(l=>{console.error("Error:",l)}),this.loading=!1},async checkAlive(){this.checkLoading=!0,await this.$axios.post("/oci/checkAlive",{}).then(l=>{this.checkLoading=!1,l.data.success?(this.checkDialogVisible=!0,this.checkResult=l.data.msg):u({message:l.data.msg,type:"error",duration:2e3}),this.fetchUsers()}).catch(l=>{console.error("Error:",l)})},async updateOciCfgName(){if(!await Q("确定要修改配置名称吗？","修改配置名称")){this.$message.info("已取消");return}this.updateCfgLoading=!0,await this.$axios.post("/oci/updateCfgName",{...this.updateCfgParams}).then(e=>{e.data.success?u({message:"修改配置名称成功",type:"success",duration:2e3}):u({message:e.data.msg,type:"error",duration:2e3}),this.updateCfgLoading=!1,this.updateCfgDialog=!1,this.fetchUsers()}).catch(e=>{console.error("Error:",e)})},handleUpdateUsername(l){this.updateCfgDialog=!0,this.updateCfgParams.cfgId=l.id,this.updateCfgParams.updateCfgName=l.username},handlePageChange(l){this.pageParams.currentPage=l,this.fetchUsers()},handleSizeChange(l){this.pageParams.currentPage=1,this.pageParams.pageSize=l,this.fetchUsers()},handleSelectionChange(l){this.selectedUsers=l},handleSingleFileUpload({file:l}){this.singleFileList=[l],this.addCfgFormData.file=l},handleFileUpload({file:l}){const e=new FileReader;e.onload=m=>{m.target.result&&this.fileList.push(l)},e.readAsArrayBuffer(l)},async uploadFile(){this.addLoading=!0;const l=new FormData;this.fileList.forEach(e=>{l.append("fileList",e)}),await this.$axios.post("/oci/uploadCfg",l,{headers:{"Content-Type":"multipart/form-data"}}).then(e=>{e.data.success?(this.resetForm(),u({message:e.data.msg,type:"success",duration:2e3})):(this.addLoading=!1,u({message:e.data.msg,type:"error",duration:2e3})),this.fetchUsers()}).catch(e=>{console.error("Error:",e)}),this.resetForm()},resetForm(){this.addCfgFormData={disabled:!1,username:"",ociCfgStr:""},this.fileList=[],this.addLoading=!1,this.dialogVisible=!1},async addUser(){if(this.singleFileList.length===0){u({message:"请先上传私钥文件",type:"warning",duration:2e3});return}const l=new FormData;l.append("username",this.addCfgFormData.username),l.append("ociCfgStr",this.addCfgFormData.ociCfgStr),l.append("file",this.addCfgFormData.file),this.addLoading=!0,await this.$axios.post("/oci/addCfg",l,{headers:{"Content-Type":"multipart/form-data"}}).then(e=>{e.data.success?(this.resetForm(),u({message:e.data.msg,type:"success",duration:2e3})):(this.addLoading=!1,u({message:e.data.msg,type:"error",duration:2e3})),this.fetchUsers()}).catch(e=>{console.error("Error:",e)})},viewDetails(l){this.$router.push({path:"/dashboard/OciCfgTab",query:{cfgId:l.id,username:l.username}})},createInstance(l){this.$router.push({path:"/dashboard/createInstance",query:{row:JSON.stringify(l)}})},createBatch(){this.$router.push({path:"/dashboard/ociCreateInstanceBatch",query:{row:JSON.stringify(this.selectedUsers)}})},async releaseSecurityRule(l){try{await G.confirm("确定要放行所有 VCN 安全列表的所有端口及协议吗？","安全列表放行操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})==="confirm"&&await this.$axios.post("/oci/releaseSecurityRule",{ociCfgId:l.id}).then(m=>{m.data.success?u({message:m.data.msg,type:"success",duration:2e3}):u({message:m.data.msg,type:"error",duration:2e3}),this.fetchUsers()}).catch(m=>{console.error("Error:",m)})}catch{u({message:"操作已取消",type:"info",duration:2e3})}},handleStopCreate(l){window.confirm("确定要停止开机任务吗?")?this.stopCreate(l):this.$message.info("已取消")},stopCreate(l){this.$axios.post("/oci/stopCreate",{userId:l.id}).then(e=>{e.data.success?u({message:e.data.msg,type:"success",duration:2e3}):u({message:e.data.msg,type:"error",duration:2e3}),this.fetchUsers()}).catch(e=>{console.error("Error:",e)})},showDeleteSelected(){window.confirm("确定要删除这些配置吗?")?this.deleteSelected():this.$message.info("取消删除")},deleteSelected(){const l=this.selectedUsers.map(e=>e.id);this.$axios.post("/oci/removeCfg",{idList:l}).then(e=>{e.data.success?u({message:e.data.msg,type:"success",duration:2e3}):u({message:e.data.msg,type:"error",duration:2e3}),this.fetchUsers()}).catch(e=>{console.error("Error:",e)})},validateForm(){this.$refs.formRef.validate(l=>{this.addCfgFormData.disabled=l})}},mounted(){this.fetchUsers()}},Y={class:"oci-user-container"},Z={class:"action-bar"},$={style:{"overflow-x":"auto"}},ee={class:"dialog-footer"},ae={class:"dialog-footer"};function te(l,e,m,x,i,n){const d=r("el-button"),h=r("el-input"),b=r("el-option"),F=r("el-select"),c=r("el-table-column"),y=r("el-tooltip"),C=r("el-tag"),S=r("el-table"),w=r("el-pagination"),_=r("el-form-item"),P=r("Key"),v=r("el-icon"),V=r("el-upload"),L=r("el-form"),U=r("el-tab-pane"),E=r("upload-filled"),T=r("el-tabs"),k=r("el-dialog"),N=j("loading");return D(),O(M,null,[g("div",Y,[g("div",Z,[t(d,{type:"success",onClick:n.fetchUsers},{default:s(()=>e[20]||(e[20]=[o("刷新")])),_:1},8,["onClick"]),t(d,{type:"primary",onClick:e[0]||(e[0]=a=>i.dialogVisible=!0)},{default:s(()=>e[21]||(e[21]=[o("新增配置")])),_:1}),t(h,{modelValue:i.pageParams.keyword,"onUpdate:modelValue":e[1]||(e[1]=a=>i.pageParams.keyword=a),placeholder:"模糊搜索名称/区域",onInput:n.fetchUsers,clearable:"","prefix-icon":"Search",class:"search-input"},null,8,["modelValue","onInput"]),t(F,{modelValue:i.pageParams.isEnableCreate,"onUpdate:modelValue":e[2]||(e[2]=a=>i.pageParams.isEnableCreate=a),onChange:n.fetchUsers,placeholder:"开机任务状态筛选",class:"status-select"},{default:s(()=>[t(b,{label:"全部",value:null}),t(b,{label:"仅显示执行开机任务中",value:1}),t(b,{label:"无开机任务",value:0})]),_:1},8,["modelValue","onChange"]),t(d,{type:"danger",onClick:n.showDeleteSelected,disabled:!i.selectedUsers.length},{default:s(()=>e[22]||(e[22]=[o(" 批量删除 ")])),_:1},8,["onClick","disabled"]),t(d,{type:"warning",onClick:n.createBatch,disabled:!i.selectedUsers.length},{default:s(()=>e[23]||(e[23]=[o(" 批量开机 ")])),_:1},8,["onClick","disabled"]),t(d,{type:"success",onClick:n.checkAlive,loading:i.checkLoading},{default:s(()=>e[24]||(e[24]=[o(" 一键测活 ")])),_:1},8,["onClick","loading"])]),g("div",$,[J((D(),K(S,{data:i.users,style:{width:"100%"},onSelectionChange:n.handleSelectionChange},{default:s(()=>[t(c,{type:"selection",width:"55"}),t(c,{label:"名称（点击修改）","min-width":"130"},{default:s(({row:a})=>[t(y,{content:a.username,placement:"top"},{default:s(()=>[t(d,{onClick:p=>n.handleUpdateUsername(a),type:"text",link:""},{default:s(()=>[o(f(a.username),1)]),_:2},1032,["onClick"])]),_:2},1032,["content"])]),_:1}),t(c,{label:"租户名","min-width":"80"},{default:s(({row:a})=>[t(C,{type:"success",onClick:p=>n.copyToClipboard(a.tenantName)},{default:s(()=>[o(f(a.tenantName),1)]),_:2},1032,["onClick"])]),_:1}),t(c,{label:"区域","min-width":"180"},{default:s(({row:a})=>[t(y,{content:a.regionName,placement:"top"},{default:s(()=>[t(C,{type:"primary"},{default:s(()=>[o(f(a.region)+"【"+f(a.regionName)+"】 ",1)]),_:2},1024)]),_:2},1032,["content"])]),_:1}),t(c,{label:"开机任务状态","min-width":"80"},{default:s(({row:a})=>[t(C,{type:a.enableCreate===1?"success":"info"},{default:s(()=>[o(f(a.enableCreate===1?"执行开机任务中":"无开机任务"),1)]),_:2},1032,["type"])]),_:1}),t(c,{sortable:"",prop:"createTime",label:"租户创建时间","min-width":"180"},{default:s(({row:a})=>[t(y,{content:a.createTime,placement:"top"},{default:s(()=>[t(C,{type:"primary"},{default:s(()=>[o(f(a.createTime),1)]),_:2},1024)]),_:2},1032,["content"])]),_:1}),t(c,{label:"操作","min-width":"200"},{default:s(({row:a})=>[t(d,{onClick:p=>n.viewDetails(a),type:"primary",link:""},{default:s(()=>e[25]||(e[25]=[o("详情")])),_:2},1032,["onClick"]),t(d,{onClick:p=>n.releaseSecurityRule(a),type:"success",link:""},{default:s(()=>e[26]||(e[26]=[o("安全列表放行")])),_:2},1032,["onClick"]),t(d,{onClick:p=>n.createInstance(a),type:"warning",link:""},{default:s(()=>e[27]||(e[27]=[o("开机")])),_:2},1032,["onClick"]),t(d,{onClick:p=>n.handleStopCreate(a),link:"",type:a.enableCreate===0?"info":"danger",disabled:a.enableCreate===0},{default:s(()=>e[28]||(e[28]=[o("停止开机 ")])),_:2},1032,["onClick","type","disabled"])]),_:1})]),_:1},8,["data","onSelectionChange"])),[[N,i.loading]])]),t(w,{onCurrentChange:n.handlePageChange,onSizeChange:n.handleSizeChange,"current-page":i.pageParams.currentPage,"onUpdate:currentPage":e[3]||(e[3]=a=>i.pageParams.currentPage=a),"page-size":i.pageParams.pageSize,"onUpdate:pageSize":e[4]||(e[4]=a=>i.pageParams.pageSize=a),"page-sizes":[5,10,20,50],total:i.total,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px"}},null,8,["onCurrentChange","onSizeChange","current-page","page-size","total"])]),t(k,{modelValue:i.dialogVisible,"onUpdate:modelValue":e[10]||(e[10]=a=>i.dialogVisible=a),title:"新增配置",width:"50%",onClose:e[11]||(e[11]=a=>i.dialogVisible=!1)},{footer:s(()=>[t(d,{onClick:e[8]||(e[8]=a=>i.dialogVisible=!1)},{default:s(()=>e[32]||(e[32]=[o("取消")])),_:1}),t(d,{type:"primary",onClick:e[9]||(e[9]=a=>i.activeTab==="manual"?n.addUser():n.uploadFile()),disabled:i.activeTab==="upload"&&this.fileList.length!==0?!1:!i.addCfgFormData.disabled,loading:i.addLoading},{default:s(()=>[o(f(i.activeTab==="manual"?"新增":"上传配置文件"),1)]),_:1},8,["disabled","loading"])]),default:s(()=>[t(T,{modelValue:i.activeTab,"onUpdate:modelValue":e[7]||(e[7]=a=>i.activeTab=a)},{default:s(()=>[t(U,{label:"手动输入",name:"manual"},{default:s(()=>[t(L,{ref:"formRef",model:i.addCfgFormData,rules:i.formRules,"label-width":"80px"},{default:s(()=>[t(_,{label:"配置名称",prop:"username"},{default:s(()=>[t(h,{modelValue:i.addCfgFormData.username,"onUpdate:modelValue":e[5]||(e[5]=a=>i.addCfgFormData.username=a),placeholder:"请输入自定义配置名称，例：这是我的首尔",clearable:""},null,8,["modelValue"])]),_:1}),t(_,{label:"配置内容",prop:"ociCfgStr"},{default:s(()=>[t(h,{modelValue:i.addCfgFormData.ociCfgStr,"onUpdate:modelValue":e[6]||(e[6]=a=>i.addCfgFormData.ociCfgStr=a),type:"textarea",placeholder:i.placeholderText,rows:"6"},null,8,["modelValue","placeholder"])]),_:1}),t(_,{label:"私钥文件",prop:"file"},{default:s(()=>[t(V,{drag:"","http-request":n.handleSingleFileUpload,style:{width:"100%"},"show-file-list":!0,"file-list":i.singleFileList},{default:s(()=>[t(v,null,{default:s(()=>[t(P)]),_:1}),e[29]||(e[29]=g("div",null,[o(" 请上传私钥文件（xxx.pem） "),g("em",null,"点击选择文件或拖动文件到此处")],-1))]),_:1},8,["http-request","file-list"])]),_:1})]),_:1},8,["model","rules"])]),_:1}),t(U,{label:"批量上传",name:"upload"},{default:s(()=>[t(V,{class:"upload-demo",drag:"","http-request":n.handleFileUpload,multiple:"","show-file-list":!0,"file-list":i.fileList},{tip:s(()=>e[30]||(e[30]=[g("div",{class:"el-upload__tip"}," ⭐要求：文件格式为.ini或者.txt，每个API配置的第一行是你[自定义的配置名称]，例：[首尔01]。 私钥文件（.pem）需要先上传至/app/oci-helper/keys目录下，然后修改配置中的key_file=私钥文件名称.pem。 上传过程中会校验配置有效性，如不符合要求则无法添加成功~ ",-1)])),default:s(()=>[t(v,{class:"el-icon--upload"},{default:s(()=>[t(E)]),_:1}),e[31]||(e[31]=g("div",{class:"el-upload__text"},[o(" Drop file here or "),g("em",null,"click to upload")],-1))]),_:1},8,["http-request","file-list"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"]),t(k,{modelValue:i.checkDialogVisible,"onUpdate:modelValue":e[13]||(e[13]=a=>i.checkDialogVisible=a),title:"测活结果",width:"35%",onClose:e[14]||(e[14]=a=>i.checkDialogVisible=!1)},{footer:s(()=>[g("div",ee,[t(d,{type:"primary",onClick:e[12]||(e[12]=a=>i.checkDialogVisible=!1)},{default:s(()=>e[33]||(e[33]=[o(" 确定 ")])),_:1})])]),default:s(()=>[g("span",null,f(this.checkResult),1)]),_:1},8,["modelValue"]),t(k,{modelValue:i.updateCfgDialog,"onUpdate:modelValue":e[18]||(e[18]=a=>i.updateCfgDialog=a),title:"修改配置名称",width:"30%",onClose:e[19]||(e[19]=a=>i.updateCfgDialog=!1)},{footer:s(()=>[g("div",ae,[t(d,{type:"info",onClick:e[16]||(e[16]=a=>i.updateCfgDialog=!1)},{default:s(()=>e[34]||(e[34]=[o(" 取消 ")])),_:1}),t(d,{type:"primary",onClick:e[17]||(e[17]=a=>n.updateOciCfgName()),loading:i.updateCfgLoading},{default:s(()=>e[35]||(e[35]=[o(" 修改 ")])),_:1},8,["loading"])])]),default:s(()=>[t(h,{modelValue:i.updateCfgParams.updateCfgName,"onUpdate:modelValue":e[15]||(e[15]=a=>i.updateCfgParams.updateCfgName=a),placeholder:"请输入自定义配置名称，例：这是我的首尔",clearable:""},null,8,["modelValue"])]),_:1},8,["modelValue"])],64)}const oe=W(X,[["render",te],["__scopeId","data-v-b38eed6a"]]);export{oe as default};
