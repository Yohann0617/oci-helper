import{u as h,c as _,o as p,b as s,w as c,r as n,k as d,a as r}from"./chunk-vendors.c9FUtYPc.js";import{_ as w}from"./index.Cw0fWXUa.js";const f={name:"GoogleCallback",components:{Loading:h},mounted(){this.handleCallback()},methods:{async handleCallback(){try{if(!sessionStorage.getItem("google_login_pending"))throw new Error("未找到登录请求");sessionStorage.removeItem("google_login_pending");let t=new URLSearchParams(window.location.search).get("credential");if(!t){await this.waitForGoogleCredential();return}if(!t)throw new Error("未获取到登录凭证");await this.sendToBackend(t)}catch(o){console.error("Google callback error:",o),d({message:o.message||"Google 登录失败，请重试",type:"error",duration:3e3}),setTimeout(()=>{this.$router.push("/login")},3e3)}},async waitForGoogleCredential(){return new Promise((o,e)=>{const t=setTimeout(()=>{e(new Error("超时：Google SDK 加载失败"))},1e4),l=setInterval(()=>{window.google&&window.google.accounts&&(clearInterval(l),clearTimeout(t),this.getGoogleClientId().then(a=>{if(!a){e(new Error("未配置 Google Client ID"));return}window.google.accounts.id.initialize({client_id:a,callback:i=>{this.sendToBackend(i.credential).then(o).catch(e)}})}).catch(e))},100)})},async getGoogleClientId(){try{const o=await this.$axios.post("/sys/getGoogleClientId",{});return o.data.success&&o.data.data?o.data.data:null}catch(o){return console.error("Failed to get Google Client ID:",o),null}},async sendToBackend(o){const e=await this.$axios.post("/sys/googleLogin",{credential:o});if(e.data.success){d({message:e.data.msg||"Google 登录成功",type:"success",duration:2e3});let t=e.data.data;sessionStorage.setItem("token",t.token),localStorage.setItem("currentVersion",t.currentVersion),localStorage.setItem("latestVersion",t.latestVersion),setTimeout(()=>{this.$router.push("/dashboard")},1e3)}else throw new Error(e.data.msg||"Google 登录失败")}}},k={class:"callback-container"},G={class:"loading-content"};function C(o,e,t,l,a,i){const g=n("Loading"),u=n("el-icon"),m=n("el-card");return p(),_("div",k,[s(m,{class:"callback-card"},{default:c(()=>[r("div",G,[s(u,{class:"loading-icon",size:50},{default:c(()=>[s(g)]),_:1}),e[0]||(e[0]=r("h2",null,"正在处理 Google 登录...",-1)),e[1]||(e[1]=r("p",null,"请稍候，即将跳转",-1))])]),_:1})])}const y=w(f,[["render",C],["__scopeId","data-v-537d5303"]]);export{y as default};
