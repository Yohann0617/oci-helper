import{_ as g}from"./index.BIFCcWVS.js";import{p as d,w as u,k as p,r as f,o as c,c as a,q as b,F as m,j as S,x as k,t as w}from"./chunk-vendors.YhVR2Zm-.js";const y={data(){return{logMessages:[],ws:null,reconnectAttempts:0,maxReconnectAttempts:5,reconnectDelay:5e3,manualClose:!1,isReconnecting:!1,isUserScrolling:!1,hasAutoScrolled:!1}},mounted(){this.initWebSocket(),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.$nextTick(()=>{var t;const e=(t=this.$refs.scrollContainer)==null?void 0:t.$el.querySelector(".el-scrollbar__wrap");e&&e.addEventListener("scroll",()=>{const o=e.scrollHeight-e.scrollTop-e.clientHeight<20;this.isUserScrolling=!o})})},beforeUnmount(){this.closeWebSocket(),document.removeEventListener("visibilitychange",this.handleVisibilityChange)},methods:{getLogLevelClass(e){return e.includes("ERROR")?"error-log":e.includes("WARN")?"warn-log":"info-log"},initWebSocket(){if(this.hasAutoScrolled=!1,this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)){console.log("WebSocket is already connected or connecting");return}if(this.isReconnecting){console.log("Currently reconnecting, skipping new connection attempt");return}this.logMessages=[],this.manualClose=!1;const e=sessionStorage.getItem("token"),s=`${this.$axios.defaults.baseURL.replace(/^http/,"ws").replaceAll("/api","")}/logs?token=${e}`;this.ws=new WebSocket(s),this.ws.onopen=()=>{console.log("WebSocket connected"),p({message:"WebSocket 连接成功，开始实时推送日志",type:"success",duration:2e3}),this.reconnectAttempts=0,this.isReconnecting=!1,this.startHeartbeat()},this.ws.onmessage=o=>{const i=o.data;this.logMessages.push(i),this.logMessages.length>200&&this.logMessages.shift(),this.$nextTick(()=>{setTimeout(()=>{var r;const n=(r=this.$refs.scrollContainer)==null?void 0:r.$el.querySelector(".el-scrollbar__wrap");if(!n)return;const l=n.scrollHeight-n.scrollTop-n.clientHeight<20;(!this.isUserScrolling||l)&&(n.scrollTop=n.scrollHeight)},100)})},this.ws.onerror=o=>{console.error("WebSocket error:",o),this.handleReconnect()},this.ws.onclose=o=>{console.warn("WebSocket closed:",o),this.stopHeartbeat(),this.manualClose||this.handleReconnect()}},scrollToBottom(e=!1){this.$nextTick(()=>{const t=this.$refs.scrollContainer;if(!t||typeof t.setScrollTop!="function")return;const s=t.$el.querySelector(".el-scrollbar__wrap");if(!s)return;const i=s.scrollHeight-s.scrollTop-s.clientHeight<20;(e||i)&&t.setScrollTop(s.scrollHeight)})},closeWebSocket(){this.ws&&(this.manualClose=!0,this.stopHeartbeat(),this.ws.close(),this.ws=null),this.logMessages=[]},startHeartbeat(){this.heartbeatInterval||(this.heartbeatInterval=setInterval(()=>{this.ws.readyState===WebSocket.OPEN&&this.ws.send("ping")},3e4))},stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)},handleReconnect(){if(this.isReconnecting||document.visibilityState==="hidden"){console.warn("Already reconnecting or page is hidden, skipping reconnect...");return}if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("Max reconnect attempts reached. Giving up.");return}this.isReconnecting=!0,setTimeout(()=>{this.reconnectAttempts++,console.log(`Reconnecting... (Attempt ${this.reconnectAttempts})`),this.initWebSocket()},this.reconnectDelay)},handleVisibilityChange(){document.visibilityState==="hidden"?this.closeWebSocket():document.visibilityState==="visible"&&this.initWebSocket()}}},v={key:0,style:{color:"#ffdd00"}};function _(e,t,s,o,i,n){const h=f("el-scrollbar");return c(),d(h,{class:"scrollbar",ref:"scrollContainer"},{default:u(()=>[i.logMessages.length===0?(c(),a("div",v,"正在加载日志...")):b("",!0),(c(!0),a(m,null,S(i.logMessages,(l,r)=>(c(),a("div",{key:r,class:k(n.getLogLevelClass(l))},w(l),3))),128))]),_:1},512)}const W=g(y,[["render",_],["__scopeId","data-v-3f23ea3b"]]);export{W as default};
