import{c as g,o as _,b as o,z as b,w as r,r as p,B as y,a as e,C as m,L as c,t as d}from"./chunk-vendors.c9FUtYPc.js";import{_ as C}from"./index.Cw0fWXUa.js";const v={data(){return{loading:!1,cards:{users:0,tasks:0,regions:0,days:0,cities:[]},cpuChart:null,memoryChart:null,trafficChart:null,ws:null,reconnectAttempts:0,maxReconnectAttempts:5,reconnectDelay:5e3,manualClose:!1,isReconnecting:!1,map:null,markers:[],cities:[{lat:40.7128,lng:-74.006,name:"çº½çº¦"},{lat:51.5074,lng:-.1278,name:"ä¼¦æ•¦"},{lat:35.6895,lng:139.6917,name:"ä¸œäº¬"},{lat:-33.8688,lng:151.2093,name:"æ‚‰å°¼"},{lat:48.8566,lng:2.3522,name:"å·´é»"},{lat:55.7558,lng:37.6173,name:"è«æ–¯ç§‘"},{lat:19.4326,lng:-99.1332,name:"å¢¨è¥¿å“¥åŸ"},{lat:-23.5505,lng:-46.6333,name:"åœ£ä¿ç½—"},{lat:1.3521,lng:103.8198,name:"æ–°åŠ å¡"},{lat:30.0444,lng:31.2357,name:"å¼€ç½—"}]}},mounted(){this.initInfo(),this.initCharts(),this.initWebSocket(),this.$router.beforeEach((s,t,a)=>{this.closeWebSocket(),a()})},beforeUnmount(){this.closeWebSocket()},methods:{async initMap(){this.loading=!0,delete c.Icon.Default.prototype._getIconUrl,c.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png"}),this.map=c.map(this.$refs.mapContainer),c.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(this.map);const s=[];if(this.cards.cities.length===0){this.loading=!1;return}for(const t of this.cards.cities){let a=`
          å›½å®¶ï¼š${t.country}<br>
          åœ°åŒºï¼š${t.area}<br>
          åŸå¸‚ï¼š${t.city}<br>
          ç»„ç»‡ï¼š${t.org}<br>
          ASNï¼š${t.asn}<br>
          æœåŠ¡å™¨æ•°é‡ï¼š${t.count}<br>
          çº¬åº¦ï¼š${t.lat}<br>
          ç»åº¦ï¼š${t.lng}
        `;const l=c.marker([t.lat,t.lng]).addTo(this.map).bindPopup(a);this.markers.push(l),s.push([t.lat,t.lng])}s.length===1?this.map.setView(s[0],4):this.map.fitBounds(s),this.loading=!1},initInfo(){this.$axios.get("/sys/glance").then(s=>{s.data.success&&(this.cards=s.data.data,localStorage.setItem("currentVersion",s.data.data.currentVersion),this.initMap())}).catch(s=>{throw console.error("Error fetching glance data:",s),s})},initCharts(){this.cpuChart=m(this.$refs.cpuChart),this.memoryChart=m(this.$refs.memoryChart),this.trafficChart=m(this.$refs.trafficChart),this.cpuChart.setOption({title:{text:"CPU ä½¿ç”¨ç‡ï¼ˆ%ï¼‰",left:"center"},tooltip:{trigger:"item"},series:[{name:"CPU ä½¿ç”¨ç‡ï¼ˆ%ï¼‰",type:"pie",radius:"50%",data:[]}]}),this.memoryChart.setOption({title:{text:"Memory ä½¿ç”¨ç‡ï¼ˆ%ï¼‰",left:"center"},tooltip:{trigger:"item"},series:[{name:"Memory ä½¿ç”¨ç‡ï¼ˆ%ï¼‰",type:"pie",radius:"50%",data:[]}]}),this.trafficChart.setOption({title:{text:"æµé‡å®æ—¶é€Ÿç‡ï¼ˆKB/sï¼‰",left:"center"},tooltip:{trigger:"axis",formatter:function(s){let t=s[0].axisValue+"<br/>";return s.forEach(a=>{t+=`${a.seriesName}: ${a.value} KB/s<br/>`}),t}},legend:{data:["å…¥ç«™","å‡ºç«™"],bottom:15},xAxis:{type:"category",data:[],axisLabel:{rotate:30}},yAxis:{type:"value",axisLabel:{formatter:"{value}"}},series:[{name:"å…¥ç«™",type:"line",data:[],smooth:!0,showSymbol:!0},{name:"å‡ºç«™",type:"line",data:[],smooth:!0,showSymbol:!0}]})},async closeWebSocket(){this.ws&&(this.ws.readyState===WebSocket.OPEN&&(this.ws.close(),await new Promise(s=>{this.ws.onclose=()=>s()})),this.ws=null,this.reconnectAttempts=0,this.isReconnecting=!1)},initWebSocket(){try{const s=sessionStorage.getItem("token"),a=`${this.$axios.defaults.baseURL.replace(/^http/,"ws").replaceAll("/api","")}/metrics/${s}`;this.ws=new WebSocket(a),this.ws.onopen=()=>{console.log("WebSocket connection established."),this.reconnectAttempts=0},this.ws.onmessage=l=>{try{const{cpuUsage:i,memoryUsage:u,trafficData:n}=JSON.parse(l.data);this.updateCharts(i,u,n)}catch(i){console.error("Error parsing message:",i)}},this.ws.onclose=l=>{console.log("WebSocket connection closed:",l)},this.ws.onerror=l=>{console.error("WebSocket error:",l)}}catch(s){console.error("Error initializing WebSocket:",s)}},updateCharts(s,t,a){this.cpuChart&&this.cpuChart.setOption({series:[{data:[{value:s.used,name:"å·²ä½¿ç”¨"},{value:s.free,name:"ç©ºé—²"}]}]}),this.memoryChart&&this.memoryChart.setOption({series:[{data:[{value:t.used,name:"å·²ä½¿ç”¨"},{value:t.free,name:"ç©ºé—²"}]}]}),this.trafficChart&&this.trafficChart.setOption({xAxis:{data:a.timestamps},series:[{name:"å…¥ç«™",data:a.inbound},{name:"å‡ºç«™",data:a.outbound}]})}}},w={class:"data-card card-blue"},x={class:"card-content"},k={class:"card-number"},S={class:"data-card card-green"},$={class:"card-content"},U={class:"card-number"},W={class:"data-card card-purple"},A={class:"card-content"},O={class:"card-number"},I={class:"data-card card-orange"},L={class:"card-content"},R={class:"card-number"},B={id:"map",ref:"mapContainer"},E={class:"chart",ref:"cpuChart"},j={class:"chart",ref:"memoryChart"},N={class:"chart",ref:"trafficChart"};function P(s,t,a,l,i,u){const n=p("el-col"),h=p("el-row"),f=y("loading");return _(),g("div",null,[o(h,{gutter:20,class:"card-container"},{default:r(()=>[o(n,{span:6},{default:r(()=>[e("div",w,[t[1]||(t[1]=e("div",{class:"card-icon"},[e("i",{class:"icon"},"ğŸ“Š")],-1)),e("div",x,[t[0]||(t[0]=e("h3",null,"æ€»APIæ•°é‡",-1)),e("p",k,d(i.cards.users),1)])])]),_:1}),o(n,{span:6},{default:r(()=>[e("div",S,[t[3]||(t[3]=e("div",{class:"card-icon"},[e("i",{class:"icon"},"âš¡")],-1)),e("div",$,[t[2]||(t[2]=e("h3",null,"å¼€æœºä»»åŠ¡æ•°é‡",-1)),e("p",U,d(i.cards.tasks),1)])])]),_:1}),o(n,{span:6},{default:r(()=>[e("div",W,[t[5]||(t[5]=e("div",{class:"card-icon"},[e("i",{class:"icon"},"ğŸŒ")],-1)),e("div",A,[t[4]||(t[4]=e("h3",null,"åŒºåŸŸæ•°é‡",-1)),e("p",O,d(i.cards.regions),1)])])]),_:1}),o(n,{span:6},{default:r(()=>[e("div",I,[t[7]||(t[7]=e("div",{class:"card-icon"},[e("i",{class:"icon"},"ğŸ“…")],-1)),e("div",L,[t[6]||(t[6]=e("h3",null,"ç³»ç»Ÿè¿è¡Œå¤©æ•°",-1)),e("p",R,d(i.cards.days),1)])])]),_:1})]),_:1}),b(e("div",B,null,512),[[f,i.loading]]),o(h,{gutter:20,class:"chart-container"},{default:r(()=>[o(n,{span:12},{default:r(()=>[o(h,{gutter:20},{default:r(()=>[o(n,{span:12},{default:r(()=>[e("div",E,null,512)]),_:1}),o(n,{span:12},{default:r(()=>[e("div",j,null,512)]),_:1})]),_:1})]),_:1}),o(n,{span:12},{default:r(()=>[e("div",N,null,512)]),_:1})]),_:1})])}const M=C(v,[["render",P],["__scopeId","data-v-1a1766dd"]]);export{M as default};
